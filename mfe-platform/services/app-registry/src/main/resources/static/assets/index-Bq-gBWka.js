import{i as g}from"./_virtual___federation_fn_import-CUp9RhQ3.js";import{c as Oe,j as t,a as Le}from"./createSvgIcon-g_45yDVV.js";import{r as Ue}from"./index-BRrI07Qo.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(a){if(a.ep)return;a.ep=!0;const s=n(a);fetch(a.href,s)}})();var te={},oe=Ue;te.createRoot=oe.createRoot,te.hydrateRoot=oe.hydrateRoot;const Be=Oe({spacing:8,shape:{borderRadius:10},palette:{mode:"light",primary:{main:"#2f5d46",light:"#4f7a62",dark:"#214333",contrastText:"#f7f8f6"},secondary:{main:"#b45f3b",light:"#cf7d57",dark:"#8f4526",contrastText:"#ffffff"},background:{default:"#f2f0ea",paper:"#fcfbf8"},divider:"#d9d4c9",text:{primary:"#2f2b24",secondary:"#5f584c"},action:{hover:"#ebe7dd",selected:"#e3ddd0"}},typography:{fontFamily:"Inter, system-ui, -apple-system, sans-serif",h4:{fontWeight:700,letterSpacing:-.2},h5:{fontWeight:700},h6:{fontWeight:600},body1:{lineHeight:1.5},body2:{lineHeight:1.45}}}),{Box:se,Stack:De,Typography:ae}=await g("@mui/material");function L({title:e,subtitle:r,actions:n}){return t.jsxs(De,{direction:{xs:"column",sm:"row"},spacing:1.5,justifyContent:"space-between",alignItems:{xs:"flex-start",sm:"center"},children:[t.jsxs(se,{children:[t.jsx(ae,{variant:"h5",children:e}),r?t.jsx(ae,{variant:"body2",color:"text.secondary",children:r}):null]}),n?t.jsx(se,{children:n}):null]})}const{Paper:Ne,Stack:qe,Typography:ie}=await g("@mui/material");function D({title:e,description:r,action:n}){return t.jsx(Ne,{variant:"outlined",sx:{p:3},children:t.jsxs(qe,{spacing:1.5,children:[t.jsx(ie,{variant:"h6",children:e}),r?t.jsx(ie,{variant:"body2",color:"text.secondary",children:r}):null,n?t.jsx("div",{children:n}):null]})})}const{Alert:Fe,Button:ze,Stack:He,Typography:le}=await g("@mui/material");function N({title:e="Something went wrong",message:r,onRetry:n}){return t.jsx(Fe,{severity:"error",children:t.jsxs(He,{spacing:1,children:[t.jsx(le,{variant:"subtitle2",children:e}),t.jsx(le,{variant:"body2",children:r}),n?t.jsx("div",{children:t.jsx(ze,{size:"small",color:"inherit",onClick:n,children:"Retry"})}):null]})})}const{Paper:We,Skeleton:ce,Stack:Ge}=await g("@mui/material");function V({lines:e=3}){return t.jsx(We,{variant:"outlined",sx:{p:2},children:t.jsxs(Ge,{spacing:1,children:[t.jsx(ce,{variant:"text",width:"45%"}),Array.from({length:e}).map((r,n)=>t.jsx(ce,{variant:"rounded",height:26},n))]})})}function K({userRoles:e,requiredRoles:r,fallback:n=null,children:o}){return r.length===0?t.jsx(t.Fragment,{children:o}):r.some(s=>e.includes(s))?t.jsx(t.Fragment,{children:o}):t.jsx(t.Fragment,{children:n})}const Je=Le(t.jsx("path",{d:"M3 18h18v-2H3zm0-5h18v-2H3zm0-7v2h18V6z"}));function Ve(){const e={NAVIGATE_TO_ACCOUNT:new Set,SHOW_TOAST:new Set,TRACK_EVENT:new Set};return{publish(r,n){e[r].forEach(a=>a(n))},subscribe(r,n){const o=e[r];return o.add(n),()=>{o.delete(n)}}}}const Re="__MFE_PLATFORM_EVENT_BUS__";function Ke(e){window[Re]=e}function Xe(){delete window[Re]}function Ye(e){const r=e.split(".");if(r.length<2)throw new Error("Invalid JWT format");const n=r[1].replace(/-/g,"+").replace(/_/g,"/"),o=n.padEnd(Math.ceil(n.length/4)*4,"="),a=atob(o);return JSON.parse(a)}function de(e,r){return r.length===0?!0:r.some(n=>e.includes(n))}function Ee(e){const r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;return`${e}-${r}`}function Qe(){return Ee("session")}function Te(){return Ee("request")}function T(e,r,n){const o={timestamp:new Date().toISOString(),level:e,event:r,...n},a=JSON.stringify(o);if(e==="error"){console.error(a);return}if(e==="warn"){console.warn(a);return}console.info(a)}function P(e){return typeof e=="object"&&e!==null}function I(e,r){if(typeof e!="string"||e.length===0)throw new Error(`Invalid manifest: ${r} must be a non-empty string`);return e}function Ze(e,r){if(typeof e!="number"||Number.isNaN(e))throw new Error(`Invalid manifest: ${r} must be a number`);return e}function et(e,r){if(!Array.isArray(e))throw new Error(`Invalid manifest: ${r} must be an array`);const n=["ADMIN","USER"];return e.map((o,a)=>{const s=I(o,`${r}[${a}]`);if(!n.includes(s))throw new Error(`Invalid manifest: ${r}[${a}] must be one of ${n.join(", ")}`);return s})}function tt(e){if(!P(e))throw new Error("Invalid manifest: payload must be an object");const r=I(e.platform,"platform");if(!Array.isArray(e.routes))throw new Error("Invalid manifest: routes must be an array");const n=e.routes.map((o,a)=>{if(!P(o))throw new Error(`Invalid manifest: routes[${a}] must be an object`);const s=`routes[${a}]`,c=I(o.id,`${s}.id`),l=I(o.title,`${s}.title`),p=I(o.path,`${s}.path`),f=et(o.requiredRoles,`${s}.requiredRoles`);if(!P(o.remote))throw new Error(`Invalid manifest: ${s}.remote must be an object`);const d=o.remote,i=I(d.scope,`${s}.remote.scope`),u=I(d.module,`${s}.remote.module`);if(!P(d.stable)||!P(d.canary))throw new Error(`Invalid manifest: ${s}.remote stable/canary must be objects`);const y={url:I(d.stable.url,`${s}.remote.stable.url`),version:I(d.stable.version,`${s}.remote.stable.version`)},b={url:I(d.canary.url,`${s}.remote.canary.url`),version:I(d.canary.version,`${s}.remote.canary.version`)};if(!P(d.rollout))throw new Error(`Invalid manifest: ${s}.remote.rollout must be an object`);const h=Ze(d.rollout.canaryPercentage,`${s}.remote.rollout.canaryPercentage`);if(h<0||h>100)throw new Error(`Invalid manifest: ${s}.remote.rollout.canaryPercentage must be between 0 and 100`);if(typeof d.rollout.canaryEnabled!="boolean")throw new Error(`Invalid manifest: ${s}.remote.rollout.canaryEnabled must be a boolean`);return{id:c,title:l,path:p,requiredRoles:f,remote:{scope:i,module:u,stable:y,canary:b,rollout:{canaryEnabled:d.rollout.canaryEnabled,canaryPercentage:h}}}});return{platform:r,routes:n}}const q="/api".replace(/\/+$/,""),rt=`${q}/registry`,nt=`${q}/auth/login`,Ie=`${q}/registry/admin/canary-flags`,ot=`${q}/telemetry`,st=`${q}/admin/telemetry`,at=12e3;let A={sessionId:"session-unknown",userId:"anonymous"};function it(e){A=e}async function F(e,r={}){const n=Te(),o=n,a=performance.now(),s=r.timeoutMs??at,c=new AbortController,l=window.setTimeout(()=>{c.abort()},s),p={"Content-Type":"application/json","X-Session-Id":A.sessionId,"X-Request-Id":n,"X-Correlation-Id":o,"X-User-Id":A.userId};r.accessToken&&(p.Authorization=`Bearer ${r.accessToken}`),T("info","api.request",{url:e,method:r.method??"GET",requestId:n,sessionId:A.sessionId});let f;try{f=await fetch(e,{method:r.method??"GET",headers:p,body:r.body===void 0?void 0:JSON.stringify(r.body),signal:c.signal})}catch(i){throw i instanceof DOMException&&i.name==="AbortError"?new Error(`Request timed out after ${s}ms: ${e}`):i}finally{window.clearTimeout(l)}const d=Math.round(performance.now()-a);if(T(f.ok?"info":"warn","api.response",{url:e,status:f.status,durationMs:d,requestId:n,sessionId:A.sessionId}),!f.ok)throw new Error(`Request failed: ${f.status} ${f.statusText}`);return await f.json()}async function lt(){const e=await F(rt);try{return tt(e)}catch(r){throw T("error","manifest.parse.failure",{error:r instanceof Error?r.message:"Unknown manifest parse error"}),r}}async function ct(e,r){return F(nt,{method:"POST",body:{username:e,password:r}})}async function dt(e){return F(Ie,{accessToken:e})}async function mt(e,r,n,o){return F(`${Ie}/${r}`,{method:"PUT",accessToken:e,body:{enabled:n,rolloutPercentage:o}})}async function z(e,r){const n=Te(),o={"Content-Type":"application/json","X-Session-Id":A.sessionId,"X-Request-Id":n,"X-Correlation-Id":n,"X-User-Id":A.userId};e&&(o.Authorization=`Bearer ${e}`),await fetch(ot,{method:"POST",headers:o,body:JSON.stringify(r)})}async function ut(e){return F(st,{accessToken:e})}const{Button:ft,Paper:ht,Slider:pt,Stack:me,Switch:yt,Table:xt,TableBody:gt,TableCell:k,TableHead:bt,TableRow:ue,Typography:jt}=await g("@mui/material"),{useEffect:wt,useState:H}=await g("react");function vt({accessToken:e,onFlagsSaved:r}){const[n,o]=H([]),[a,s]=H(!0),[c,l]=H(null),[p,f]=H(null);wt(()=>{let i=!1;return s(!0),f(null),dt(e).then(u=>{i||o(u)}).catch(u=>{i||f(u instanceof Error?u.message:"Failed to load canary flags")}).finally(()=>{i||s(!1)}),()=>{i=!0}},[e]);const d=async i=>{l(i.remoteId),f(null);try{const u=await mt(e,i.remoteId,i.enabled,i.rolloutPercentage);o(y=>y.map(b=>b.remoteId===u.remoteId?u:b)),r()}catch(u){f(u instanceof Error?u.message:"Failed to save canary flag")}finally{l(null)}};return a?t.jsx(V,{lines:5}):t.jsx(ht,{sx:{p:2},children:t.jsxs(me,{spacing:2,children:[t.jsx(L,{title:"Canary Control",subtitle:"ADMIN-only rollout controls for remote canary versions."}),p?t.jsx(N,{message:p}):null,n.length===0?t.jsx(D,{title:"No remotes available",description:"Registry returned no canary-configurable remotes."}):null,n.length>0?t.jsxs(xt,{size:"small",children:[t.jsx(bt,{children:t.jsxs(ue,{children:[t.jsx(k,{children:"Remote"}),t.jsx(k,{children:"Canary Enabled"}),t.jsx(k,{children:"Rollout %"}),t.jsx(k,{children:"Actions"})]})}),t.jsx(gt,{children:n.map(i=>t.jsxs(ue,{children:[t.jsx(k,{children:i.remoteId}),t.jsx(k,{children:t.jsx(yt,{checked:i.enabled,onChange:u=>{const y=u.target.checked;o(b=>b.map(h=>h.remoteId===i.remoteId?{...h,enabled:y}:h))}})}),t.jsx(k,{sx:{minWidth:220},children:t.jsxs(me,{direction:"row",spacing:1.5,alignItems:"center",children:[t.jsx(pt,{size:"small",min:0,max:100,disabled:!i.enabled,value:i.rolloutPercentage,onChange:(u,y)=>{const b=typeof y=="number"?y:y[0];o(h=>h.map(j=>j.remoteId===i.remoteId?{...j,rolloutPercentage:b}:j))}}),t.jsxs(jt,{variant:"body2",sx:{width:36,textAlign:"right"},children:[i.rolloutPercentage,"%"]})]})}),t.jsx(k,{children:t.jsx(ft,{size:"small",variant:"contained",onClick:()=>void d(i),disabled:c===i.remoteId,children:c===i.remoteId?"Saving...":"Save"})})]},i.remoteId))})]}):null]})})}const{Alert:Rt,Box:fe,Button:Et,Paper:Tt,Stack:It,TextField:he,Typography:$t}=await g("@mui/material"),{useState:W}=await g("react");function St({onAuthenticated:e}){const[r,n]=W("user"),[o,a]=W("password"),[s,c]=W(null),[l,p]=W(!1),f=async d=>{d.preventDefault(),p(!0),c(null);try{const i=await ct(r,o),u=Ye(i.accessToken);e({accessToken:i.accessToken,roles:i.roles,username:u.sub??r})}catch(i){const u=i instanceof Error?i.message:"Login failed";c(u)}finally{p(!1)}};return t.jsx(fe,{sx:{minHeight:"100vh",display:"grid",placeItems:"center",p:2},children:t.jsxs(Tt,{sx:{p:{xs:2.5,sm:3},width:"100%",maxWidth:460,border:1,borderColor:"divider"},children:[t.jsx(L,{title:"Mock Login",subtitle:"Authenticate against app-registry local JWT issuer."}),t.jsx($t,{variant:"body2",sx:{mt:1.5,mb:2.5,color:"text.secondary"},children:"Use username `admin` for ADMIN+USER roles, or any other username for USER role."}),t.jsx(Rt,{severity:"info",sx:{mb:2.5,border:1,borderColor:"divider"},children:"Access token is kept in memory only. For production, use short-lived access tokens with refresh via HttpOnly secure cookie."}),s?t.jsx(fe,{sx:{mb:2},children:t.jsx(N,{message:s})}):null,t.jsxs(It,{component:"form",spacing:2,onSubmit:f,children:[t.jsx(he,{label:"Username",value:r,onChange:d=>n(d.target.value),required:!0,size:"small"}),t.jsx(he,{label:"Password",type:"password",value:o,onChange:d=>a(d.target.value),required:!0,size:"small"}),t.jsx(Et,{type:"submit",variant:"contained",disabled:l,sx:{mt:1,py:1},children:l?"Signing in...":"Sign in"})]})]})})}const J="mfe-shell.manifest.v1",_t=10*60*1e3;function $e(e){return typeof window>"u"||!window.localStorage?null:window.localStorage}function Ct(e,r){const n=_t,o=Date.now(),a=$e();if(!a)return;const s={cachedAt:o,expiresAt:o+n,value:e};a.setItem(J,JSON.stringify(s))}function kt(e){const r=Date.now(),n=$e();if(!n)return null;const o=n.getItem(J);if(!o)return null;try{const a=JSON.parse(o);return!a.expiresAt||a.expiresAt<r?(n.removeItem(J),null):a.value}catch{return n.removeItem(J),null}}const{createContext:At,useContext:Mt}=await g("react"),Se=At(null);function _e(){const e=Mt(Se);if(!e)throw new Error("useRegistryContext must be used within RegistryContext.Provider");return e}const Ce={remote_accounts:{url:"runtime:remote_accounts",format:"esm",from:"vite"},remote_billing:{url:"runtime:remote_billing",format:"esm",from:"vite"},remote_analytics:{url:"runtime:remote_analytics",format:"esm",from:"vite"}},pe={},Pt=async(e,r)=>{const n=typeof e=="function"?await e():e,o=document.createElement("script");o.type="text/javascript",o.onload=r,o.src=n,document.getElementsByTagName("head")[0].appendChild(o)};function G(e,r){return Ot(e).then(n=>()=>r==="webpack"&&Object.prototype.toString.call(n).indexOf("Module")>-1&&n.default?n.default:n)}function ke(e,r){const n=Object.assign(e,r);for(const o of Object.keys(n))typeof n[o]=="object"&&typeof r[o]=="object"&&(n[o]=ke(n[o],r[o]));return n}const ye=e=>ke({react:{"18.3.1":{get:()=>G(new URL("__federation_shared_react-B_uPfkFG.js",import.meta.url).href,e),loaded:1}},"react-dom":{"18.3.1":{get:()=>G(new URL("__federation_shared_react-dom-DUZ-Ojwg.js",import.meta.url).href,e),loaded:1}},"react-router-dom":{"6.30.3":{get:()=>G(new URL("__federation_shared_react-router-dom-BvzYyowF.js",import.meta.url).href,e),loaded:1}},"@mui/material":{"7.3.8":{get:()=>G(new URL("__federation_shared_@mui/material-DLp9Ue-e.js",import.meta.url).href,e),loaded:1}}},(globalThis.__federation_shared__||{}).default||{});async function Ot(e){return pe[e]??=import(e),pe[e]}async function Lt(e){const r=Ce[e];if(r.inited)return r.lib;if(r.format==="var")return new Promise(n=>{const o=()=>{r.inited||(r.lib=window[e],r.lib.init(ye(r.from)),r.inited=!0),n(r.lib)};return Pt(r.url,o)});if(["esm","systemjs"].includes(r.format))return new Promise((n,o)=>{(typeof r.url=="function"?r.url:()=>Promise.resolve(r.url))().then(s=>{import(s).then(c=>{if(!r.inited){const l=ye(r.from);c.init(l),r.lib=c,r.lib.init(l),r.inited=!0}n(r.lib)}).catch(o)})})}function Ut(e){return e?.__esModule||e?.[Symbol.toStringTag]==="Module"?e.default:e}function Bt(e,r){return Lt(e).then(n=>n.get(r).then(o=>o()))}function Dt(e,r){Ce[e]=r}function Nt(e){let r=0;for(let n=0;n<e.length;n+=1)r=r*31+e.charCodeAt(n)>>>0;return r%100}function qt(e,r,n){const o=Math.max(0,Math.min(100,n));return Nt(`${e}:${r}`)<o}function Ft(e,r){return e.remote.rollout.canaryEnabled&&qt(r,e.id,e.remote.rollout.canaryPercentage)?"canary":"stable"}function zt(e,r){const n=Ft(e,r);return{variant:n,preferred:n==="canary"?e.remote.canary:e.remote.stable,fallback:e.remote.stable}}const{Component:Ht}=await g("react");class Wt extends Ht{state={hasError:!1,message:""};static getDerivedStateFromError(r){return{hasError:!0,message:r.message}}componentDidCatch(r,n){this.props.onError(r.message)}render(){return this.state.hasError?this.props.fallback?this.props.fallback:t.jsx(N,{title:`${this.props.title} failed`,message:this.state.message}):this.props.children}}const{Button:Gt,Paper:Jt,Stack:Vt,Typography:Kt}=await g("@mui/material");function Xt({title:e,error:r,onRetry:n}){return t.jsx(Jt,{sx:{p:2},children:t.jsxs(Vt,{spacing:2,children:[t.jsx(L,{title:`${e} (Degraded)`,subtitle:"Remote failed to load. Showing local fallback."}),t.jsx(D,{title:"Troubleshooting",description:"Verify remote dev server is running, check network/CORS, and confirm remoteEntry URL and federation scope match registry config.",action:t.jsx(Gt,{variant:"contained",onClick:n,children:"Retry Load Remote"})}),t.jsxs(Kt,{variant:"body2",color:"text.secondary",children:["Last error: ",r]})]})})}function Yt(e,r=500,n=8e3){const o=Math.max(0,e);return Math.min(r*Math.pow(2,o),n)}function Qt(e,r=500,n=8e3){return Array.from({length:Math.max(0,e)},(o,a)=>Yt(a,r,n))}const{Box:Zt,CircularProgress:er,Stack:xe,Typography:tr}=await g("@mui/material"),{lazy:rr,Suspense:nr,useMemo:or,useState:ge}=await g("react"),X=new Map,sr=15e3;function ar(e){return e.endsWith("/assets/remoteEntry.js")?e.replace("/assets/remoteEntry.js","/remoteEntry.js"):e.endsWith("/remoteEntry.js")?e.replace("/remoteEntry.js","/assets/remoteEntry.js"):null}function Ae(e){const r=e instanceof Error?e.message:String(e);return/404|ERR_ABORTED|Failed to fetch dynamically imported module/i.test(r)}function ir(e){return Ae(e)}async function lr(e,r,n){return new Promise((o,a)=>{const s=window.setTimeout(()=>{a(new Error(`${n} timed out after ${r}ms`))},r);e.then(c=>{window.clearTimeout(s),o(c)}).catch(c=>{window.clearTimeout(s),a(c)})})}async function be(e,r){const n=`${e.remote.scope}|${e.remote.module}|${r}`,o=X.get(n);if(o)return o;const a=lr((async()=>{const s=async c=>{Dt(e.remote.scope,{url:c,format:"esm",from:"vite"});const l=await Bt(e.remote.scope,e.remote.module);return await Ut(l)};try{return await s(r)}catch(c){const l=ar(r);if(!l||!Ae(c))throw c;return T("warn","remote.load.entry_path_fallback",{routeId:e.id,scope:e.remote.scope,originalUrl:r,fallbackUrl:l,error:c instanceof Error?c.message:String(c)}),s(l)}})(),sr,`Remote ${e.remote.scope}`).catch(s=>{throw X.delete(n),s});return X.set(n,a),a}function cr({route:e,userId:r,accessToken:n}){const{updateRemoteStatus:o}=_e(),[a,s]=ge(0),[c,l]=ge("Remote failed to load."),p=or(()=>rr(async()=>{const f=zt(e,r),d=f.variant==="canary",i=f.preferred,u=f.fallback,y=performance.now();T("info","remote.load.attempt",{routeId:e.id,scope:e.remote.scope,userId:r,variant:d?"canary":"stable",url:i.url});const b=Qt(3,500,4e3);for(let h=0;h<=b.length;h+=1)try{o(e.remote.scope,{state:"loading",error:void 0,retryCount:h,degraded:!1});const j=await be(e,i.url);o(e.remote.scope,{state:"loaded",version:i.version,variant:d?"canary":"stable",loadedAt:new Date().toISOString(),error:void 0,retryCount:h,degraded:!1});const w=Math.round(performance.now()-y);return T("info","remote.load.success",{routeId:e.id,scope:e.remote.scope,variant:d?"canary":"stable",version:i.version,durationMs:w,attempts:h+1}),z(n,{eventType:"REMOTE_LOAD_SUCCESS",remoteId:e.remote.scope,routeId:e.id,level:"INFO",durationMs:w,metadata:{variant:d?"canary":"stable",version:i.version,attempts:h+1}}),{default:j}}catch(j){const w=j instanceof Error?j.message:"Unknown remote loading error",C=Math.round(performance.now()-y);if(l(w),d){T("warn","remote.load.canary_failed_fallback",{routeId:e.id,userId:r,canaryUrl:i.url,stableUrl:u.url,error:w,durationMs:C}),z(n,{eventType:"REMOTE_LOAD_CANARY_FAILED",remoteId:e.remote.scope,routeId:e.id,level:"WARN",durationMs:C,message:w,metadata:{canaryVersion:i.version,stableVersion:u.version}});try{const m=await be(e,u.url);return o(e.remote.scope,{state:"loaded",version:u.version,variant:"stable",loadedAt:new Date().toISOString(),error:`Canary failed, fallback to stable: ${w}`,degraded:!0,retryCount:h}),T("info","remote.load.stable_fallback_success",{routeId:e.id,scope:e.remote.scope,version:u.version}),{default:m}}catch(m){const x=m instanceof Error?m.message:"Unknown stable fallback error";throw l(x),o(e.remote.scope,{state:"error",error:x,degraded:!0,retryCount:h}),T("error","remote.load.stable_fallback_failed",{routeId:e.id,scope:e.remote.scope,error:x}),z(n,{eventType:"REMOTE_LOAD_FAILURE",remoteId:e.remote.scope,routeId:e.id,level:"ERROR",durationMs:C,message:x,metadata:{attemptedVariant:"stable-fallback"}}),m}}if(h<b.length){if(ir(j))throw o(e.remote.scope,{state:"error",error:w,degraded:!0,retryCount:h}),T("error","remote.load.non_retryable_failure",{routeId:e.id,scope:e.remote.scope,error:w,attempt:h+1}),j;const m=b[h];T("warn","remote.load.retry_scheduled",{routeId:e.id,scope:e.remote.scope,attempt:h+1,backoffMs:m,error:w}),await new Promise(x=>setTimeout(x,m));continue}throw o(e.remote.scope,{state:"error",error:w,degraded:!0,retryCount:h}),T("error","remote.load.failure",{routeId:e.id,scope:e.remote.scope,error:w,durationMs:C}),z(n,{eventType:"REMOTE_LOAD_FAILURE",remoteId:e.remote.scope,routeId:e.id,level:"ERROR",durationMs:C,message:w,metadata:{attemptedVariant:d?"canary":"stable"}}),j}throw new Error("Remote failed to load after retry schedule")}),[n,a,e,o,r]);return t.jsx(Wt,{title:e.title,onError:f=>{l(d=>d===f?d:f)},fallback:t.jsx(Xt,{title:e.title,error:c,onRetry:()=>s(f=>f+1)}),children:t.jsx(nr,{fallback:t.jsxs(xe,{spacing:1.5,children:[t.jsxs(xe,{direction:"row",spacing:1,alignItems:"center",children:[t.jsx(er,{size:20}),t.jsxs(tr,{variant:"body2",children:["Loading ",e.title,"..."]})]}),t.jsx(V,{lines:3})]}),children:t.jsx(Zt,{children:t.jsx(p,{})})})},`${e.id}-${a}`)}const{Chip:dr,Paper:mr,Table:ur,TableBody:fr,TableCell:E,TableContainer:hr,TableHead:pr,TableRow:je,Typography:yr}=await g("@mui/material");function xr(e){return e==="loaded"?"success":e==="error"?"error":e==="loading"?"warning":"default"}function gr(){const{statuses:e}=_e(),r=Object.values(e);return t.jsxs(mr,{sx:{p:{xs:1.5,sm:2},border:1,borderColor:"divider"},children:[t.jsx(L,{title:"Remote Status",subtitle:"Inspect remote loading state, version alignment, and errors."}),t.jsx(yr,{sx:{mb:2}}),r.length===0?t.jsx(D,{title:"No remotes configured",description:"Registry did not return any remotes."}):null,t.jsx(hr,{sx:{border:1,borderColor:"divider",borderRadius:1.5},children:t.jsxs(ur,{size:"small",children:[t.jsx(pr,{sx:{bgcolor:"action.hover"},children:t.jsxs(je,{children:[t.jsx(E,{children:"Remote"}),t.jsx(E,{children:"Scope"}),t.jsx(E,{children:"Version"}),t.jsx(E,{children:"Status"}),t.jsx(E,{children:"Last Loaded"}),t.jsx(E,{children:"Error"})]})}),t.jsx(fr,{children:r.map(n=>t.jsxs(je,{hover:!0,children:[t.jsx(E,{children:n.title}),t.jsx(E,{children:n.scope}),t.jsx(E,{children:n.version}),t.jsx(E,{children:t.jsx(dr,{label:n.state,color:xr(n.state),size:"small"})}),t.jsx(E,{children:n.loadedAt??"-"}),t.jsx(E,{children:n.error??"-"})]},n.scope))})]})})]})}const{Paper:br,Stack:jr,Table:wr,TableBody:vr,TableCell:v,TableHead:Rr,TableRow:we}=await g("@mui/material"),{useEffect:Er,useState:Y}=await g("react");function Tr({accessToken:e}){const[r,n]=Y([]),[o,a]=Y(!0),[s,c]=Y(null);return Er(()=>{let l=!1;return a(!0),c(null),ut(e).then(p=>{l||n(p)}).catch(p=>{l||c(p instanceof Error?p.message:"Failed to load telemetry")}).finally(()=>{l||a(!1)}),()=>{l=!0}},[e]),o?t.jsx(V,{lines:6}):s?t.jsx(N,{title:"Telemetry load failed",message:s}):r.length===0?t.jsx(D,{title:"No telemetry yet",description:"Client events will appear here once remotes start loading."}):t.jsx(br,{sx:{p:2},children:t.jsxs(jr,{spacing:2,children:[t.jsx(L,{title:"Telemetry Dashboard",subtitle:"In-memory telemetry events received by app-registry."}),t.jsxs(wr,{size:"small",children:[t.jsx(Rr,{children:t.jsxs(we,{children:[t.jsx(v,{children:"Time"}),t.jsx(v,{children:"Event"}),t.jsx(v,{children:"Remote"}),t.jsx(v,{children:"Level"}),t.jsx(v,{children:"Duration"}),t.jsx(v,{children:"Correlation ID"}),t.jsx(v,{children:"Message"})]})}),t.jsx(vr,{children:r.map(l=>t.jsxs(we,{children:[t.jsx(v,{children:l.timestamp}),t.jsx(v,{children:l.eventType}),t.jsx(v,{children:l.remoteId??"-"}),t.jsx(v,{children:l.level}),t.jsx(v,{children:l.durationMs??"-"}),t.jsx(v,{children:l.correlationId}),t.jsx(v,{children:l.message??"-"})]},`${l.requestId}-${l.timestamp}`))})]})]})})}const{AppBar:Ir,Alert:re,Box:$,Button:$r,CircularProgress:Sr,CssBaseline:_r,Drawer:ve,IconButton:Cr,List:kr,ListItemButton:Ar,ListItemText:Mr,Snackbar:Pr,Toolbar:Q,Typography:Z}=await g("@mui/material"),{useCallback:Or,useEffect:B,useMemo:Lr,useRef:Me,useState:_}=await g("react"),{BrowserRouter:Ur,Navigate:Br,Route:U,Routes:Dr,useLocation:Nr,useNavigate:qr}=await g("react-router-dom"),O=280;function ee({requiredRoles:e}){return t.jsx(D,{title:"Access denied",description:`Required role: ${e.join(" or ")}.`})}function Fr({routes:e,authState:r,onLogout:n,onCanaryFlagsSaved:o}){const[a,s]=_(!1),[c,l]=_(null),p=qr(),f=Nr(),d=Me(Ve()).current;B(()=>(Ke(d),()=>{Xe()}),[d]),B(()=>{const m=d.subscribe("NAVIGATE_TO_ACCOUNT",({accountId:S,route:M})=>{p(`${M??"/accounts"}?accountId=${encodeURIComponent(S)}`)}),x=d.subscribe("SHOW_TOAST",({message:S,severity:M="info"})=>{l({message:S,severity:M})}),R=d.subscribe("TRACK_EVENT",({name:S,properties:M})=>{console.info("[platform-track-event]",S,M??{})});return()=>{m(),x(),R()}},[p,d]);const[i,u]=_(()=>e.reduce((m,x)=>(m[x.remote.scope]={id:x.id,title:x.title,scope:x.remote.scope,version:x.remote.stable.version,variant:"stable",state:"idle"},m),{}));B(()=>{u(m=>{const x={...m};return e.forEach(R=>{x[R.remote.scope]||(x[R.remote.scope]={id:R.id,title:R.title,scope:R.remote.scope,version:R.remote.stable.version,variant:"stable",state:"idle"})}),x})},[e]);const y=Or((m,x)=>{u(R=>{const S=R[m];return!S||Object.entries(x).every(([ne,Pe])=>S[ne]===Pe)?R:{...R,[m]:{...S,...x}}})},[]),b=Lr(()=>({routes:e,statuses:i,updateRemoteStatus:y}),[e,i,y]),h=Object.values(i).some(m=>m.degraded||m.state==="error"),j=[...e.filter(m=>de(r.roles,m.requiredRoles)).map(m=>({key:m.id,label:m.title,path:m.path})),{key:"debug-remotes",label:"Remote Status",path:"/debug/remotes"},...r.roles.includes("ADMIN")?[{key:"canary-control",label:"Canary Control",path:"/admin/canary-control"},{key:"telemetry",label:"Telemetry",path:"/admin/telemetry"}]:[]],w=e.find(m=>de(r.roles,m.requiredRoles))?.path??"/debug/remotes",C=t.jsxs($,{sx:{height:"100%",display:"flex",flexDirection:"column",bgcolor:"background.paper"},children:[t.jsxs(Q,{sx:{borderBottom:1,borderColor:"divider",px:2},children:[t.jsx(Z,{variant:"h6",noWrap:!0,children:"mfe-platform"}),t.jsxs(Z,{variant:"caption",sx:{ml:"auto",color:"text.secondary"},children:[r.username," (",r.roles.join(", "),")"]})]}),t.jsx(kr,{sx:{px:1,py:1,flexGrow:1},children:j.map(m=>t.jsx(Ar,{selected:f.pathname===m.path,sx:{borderRadius:1,mb:.5,"&.Mui-selected":{bgcolor:"action.selected",borderLeft:3,borderColor:"primary.main",pl:1.5}},onClick:()=>{p(m.path),s(!1)},children:t.jsx(Mr,{primary:m.label})},m.key))}),t.jsx($,{sx:{px:2,pb:2,pt:1,borderTop:1,borderColor:"divider"},children:t.jsx($r,{onClick:n,variant:"outlined",fullWidth:!0,children:"Logout"})})]});return t.jsxs(Se.Provider,{value:b,children:[t.jsxs($,{sx:{display:"flex"},children:[t.jsx(_r,{}),t.jsx(Ir,{position:"fixed",color:"inherit",elevation:0,sx:{width:{sm:`calc(100% - ${O}px)`},ml:{sm:`${O}px`},bgcolor:"background.paper",borderBottom:1,borderColor:"divider"},children:t.jsxs(Q,{sx:{minHeight:68},children:[t.jsx(Cr,{color:"inherit",edge:"start",onClick:()=>s(!a),sx:{mr:2,display:{sm:"none"},color:"text.primary"},children:t.jsx(Je,{})}),t.jsx(Z,{variant:"h6",noWrap:!0,component:"div",sx:{color:"text.primary"},children:"Shell Host"})]})}),t.jsxs($,{component:"nav",sx:{width:{sm:O},flexShrink:{sm:0}},children:[t.jsx(ve,{variant:"temporary",open:a,onClose:()=>s(!1),ModalProps:{keepMounted:!0},sx:{display:{xs:"block",sm:"none"},"& .MuiDrawer-paper":{boxSizing:"border-box",width:O,borderRight:1,borderColor:"divider"}},children:C}),t.jsx(ve,{variant:"permanent",sx:{display:{xs:"none",sm:"block"},"& .MuiDrawer-paper":{boxSizing:"border-box",width:O,borderRight:1,borderColor:"divider"}},open:!0,children:C})]}),t.jsxs($,{component:"main",sx:{flexGrow:1,p:{xs:2,sm:3},width:{sm:`calc(100% - ${O}px)`}},children:[t.jsx(Q,{}),h?t.jsx(re,{severity:"warning",sx:{mb:2,border:1,borderColor:"divider"},children:"Degraded mode active: one or more remotes failed and fallback pages are being shown."}):null,t.jsx($,{sx:{mb:2,px:{xs:.5,sm:1}},children:t.jsx(L,{title:"Shell Host",subtitle:"Runtime composition of role-aware microfrontends."})}),t.jsx($,{sx:{bgcolor:"background.paper",border:1,borderColor:"divider",borderRadius:2,p:{xs:1.5,sm:2}},children:t.jsxs(Dr,{children:[e.map(m=>t.jsx(U,{path:m.path,element:t.jsx(K,{userRoles:r.roles,requiredRoles:m.requiredRoles,fallback:t.jsx(ee,{requiredRoles:m.requiredRoles}),children:t.jsx(cr,{route:m,userId:r.username??"anonymous",accessToken:r.accessToken})})},m.id)),t.jsx(U,{path:"/debug/remotes",element:t.jsx(gr,{})}),t.jsx(U,{path:"/admin/canary-control",element:t.jsx(K,{userRoles:r.roles,requiredRoles:["ADMIN"],fallback:t.jsx(ee,{requiredRoles:["ADMIN"]}),children:t.jsx(vt,{accessToken:r.accessToken??"",onFlagsSaved:o})})}),t.jsx(U,{path:"/admin/telemetry",element:t.jsx(K,{userRoles:r.roles,requiredRoles:["ADMIN"],fallback:t.jsx(ee,{requiredRoles:["ADMIN"]}),children:t.jsx(Tr,{accessToken:r.accessToken??""})})}),t.jsx(U,{path:"*",element:t.jsx(Br,{to:w,replace:!0})})]})})]})]}),t.jsx(Pr,{open:!!c,autoHideDuration:3e3,onClose:()=>l(null),anchorOrigin:{vertical:"bottom",horizontal:"right"},children:t.jsx(re,{onClose:()=>l(null),severity:c?.severity??"info",variant:"filled",sx:{width:"100%"},children:c?.message})})]})}function zr(){const[e,r]=_([]),[n,o]=_(null),[a,s]=_(!0),[c,l]=_({accessToken:null,roles:[],username:null}),[p,f]=_(0),[d,i]=_(null),u=Me(Qe()).current;return B(()=>{it({sessionId:u,userId:c.username??"anonymous"})},[c.username,u]),B(()=>{let y=!1;return s(!0),lt().then(b=>{y||(r(b.routes),Ct(b),i(null))}).catch(b=>{if(!y){const h=kt();if(h)r(h.routes),i("Registry unavailable; using last-known-good manifest cache."),o(null);else{const j=b instanceof Error?b.message:"Unknown registry fetch error";o(j)}}}).finally(()=>{y||s(!1)}),()=>{y=!0}},[p]),a?t.jsx($,{sx:{minHeight:"100vh",display:"grid",placeItems:"center"},children:t.jsxs($,{sx:{width:420},children:[t.jsx(V,{lines:4}),t.jsx($,{sx:{mt:1,display:"grid",placeItems:"center"},children:t.jsx(Sr,{size:20})})]})}):n?t.jsx($,{sx:{p:3},children:t.jsx(N,{title:"Failed to load route config from app-registry",message:n})}):c.accessToken?t.jsxs(t.Fragment,{children:[d?t.jsx(re,{severity:"warning",sx:{borderRadius:0},children:d}):null,t.jsx(Ur,{children:t.jsx(Fr,{routes:e,authState:c,onLogout:()=>l({accessToken:null,roles:[],username:null}),onCanaryFlagsSaved:()=>f(y=>y+1)})})]}):t.jsx(St,{onAuthenticated:l})}const Hr=await g("react"),{CssBaseline:Wr,ThemeProvider:Gr}=await g("@mui/material");te.createRoot(document.getElementById("root")).render(t.jsx(Hr.StrictMode,{children:t.jsxs(Gr,{theme:Be,children:[t.jsx(Wr,{}),t.jsx(zr,{})]})}));
